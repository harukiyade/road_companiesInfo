# CNAVI スクレイピング実行ガイド

## 概要

`cnavi-app.g-search.or.jp` から企業情報をスクレイピングしてCSVに出力するスクリプトです。

## 前提条件

- Node.js がインストールされていること
- 環境変数 `CNAVI_LOGIN_ID` と `CNAVI_PASSWORD` が設定されていること

## セットアップ

### 1. 依存関係のインストール

```bash
npm install
```

または

```bash
npm install playwright csv-writer
npx playwright install chromium
```

### 2. 環境変数の設定

```bash
export CNAVI_LOGIN_ID="h.shiroyama@legatuscorp.com"
export CNAVI_PASSWORD="Furapote0403/"
```

または、実行時に直接指定：

```bash
CNAVI_LOGIN_ID="h.shiroyama@legatuscorp.com" CNAVI_PASSWORD="Furapote0403/" npx tsx scripts/cnavi_scrape.ts
```

## 実行手順

### 1. スクリプトを起動

```bash
CNAVI_LOGIN_ID="h.shiroyama@legatuscorp.com" CNAVI_PASSWORD="Furapote0403/" npx tsx scripts/cnavi_scrape.ts
```

### 2. ログイン処理

スクリプトが自動的にログイン処理を実行します。ブラウザが表示され、ログインが完了するまで待機します。

### 3. 企業リストの表示

ログイン後、**手動で**以下を実行してください：

1. 検索条件を入力
2. 検索を実行
3. 企業リストが表示されるまで待機

### 4. スクレイピング開始

企業リストが表示されたら、**ターミナルで Enter キーを押してください**。

スクリプトが自動的に以下を実行します：

- 各企業の詳細ページに遷移
- 企業情報を取得
- CSVに出力
- 次の企業へ
- ページング処理（自動で次ページへ）

### 5. 完了

すべての企業の処理が完了するか、次ページが見つからなくなると自動的に終了します。

## 出力ファイル

- **CSVファイル**: `out/cnavi_companies.csv`
  - companies_newコレクションの全フィールドに対応
  - 1社ごとに追記されるため、途中終了してもデータは保持されます

- **ログファイル**: `out/cnavi_scrape.log`
  - すべての実行ログが記録されます
  - タイムスタンプ付きで記録されます
  - エラー情報も含まれます

## 実行フロー

スクリプトは以下のフローで実行されます：

1. **通常モードでブラウザ起動** - ログイン処理までブラウザが表示されます
2. **ログイン処理** - 自動的にログインを実行します
3. **Enterキー待ち** - 企業リストを表示してからEnterキーを押してください
4. **バックグラウンドモードに切り替え** - Enterキーを押すと、自動的にheadlessモードに切り替わり、ブラウザが非表示になります
5. **スクレイピング実行** - バックグラウンドでスクレイピングが実行されます

**注意**: 企業リストが表示されている状態でEnterキーを押してください。Enterキーを押すと、ブラウザが非表示になり、バックグラウンドでスクレイピングが開始されます。

## ログファイル

すべてのログは `out/cnavi_scrape.log` に自動的に保存されます。

ログを確認するには：

```bash
# リアルタイムでログを確認
tail -f out/cnavi_scrape.log

# ログの最後の100行を表示
tail -n 100 out/cnavi_scrape.log

# ログ全体を表示
cat out/cnavi_scrape.log
```

ログには以下の情報が記録されます：
- タイムスタンプ付きのすべてのメッセージ
- エラーメッセージ
- 進捗情報（ページ番号、企業数、エラー数など）

## デバッグモード

HTMLを保存してデバッグする場合：

```bash
SAVE_HTML=1 CNAVI_LOGIN_ID="..." CNAVI_PASSWORD="..." npx tsx scripts/cnavi_scrape.ts
```

保存先: `out/html/` ディレクトリ

## 取得される情報

スクリプトは以下の情報を取得します：

1. **詳細ページ上部のサマリー**
   - 企業名
   - カナ
   - 法人番号
   - 更新日
   - バッジ/タグ

2. **基本情報テーブル**
   - 企業名/カナ
   - 法人番号
   - 住所/郵便番号
   - 設立日
   - 資本金
   - 従業員数
   - 上場・非上場
   - ホームページURL
   - 問い合わせページURL
   - 電話番号
   - 代表者名

3. **業種・事業情報**
   - 業種チップ（複数は `|` 区切り）
   - 事業内容チップ（複数は `|` 区切り）

4. **業績情報**
   - 売上（最大直近5期分）
   - 決算年月（最大直近5期分）

## 値の正規化

- **金額**: `200,000,000円` → `200000000`
- **人数**: `1,011人` → `1011`
- **日付**: `1949年04月05日` → `1949-04-05`
- **チップ/タグ**: 複数は `|` 区切り（例: `運輸業|郵便業|道路貨物運送業`）

## companyId の生成ルール

- 法人番号がある場合: `companyId = corporateNumber`
- 法人番号がない場合: `companyId = hash(name + address)` （SHA256の先頭16文字）

## エラーハンドリング

- 企業詳細の取得に失敗した場合、最低限 `companyId` と `name` を出力
- エラーはログに出力されます
- エラーが発生しても処理は継続します

## 進捗ログ

スクリプトは以下の情報を標準出力に表示します：

```
📄 ページ 1 を処理中...
  📋 20 件の企業が見つかりました
  [1/20] 松岡満運輸株式会社 を処理中...
  ✅ 完了: 松岡満運輸株式会社 (companyId: 4430001016114)
  ...
```

## 注意事項

- スクレイピング許可は株式会社ジー・サーチ代表から取得済みです
- ブラウザは headed モード（表示あり）で実行されます
- ページングは自動で処理されますが、次ページが見つからない場合は30秒待機して終了します
- 途中終了してもCSVは壊れません（1社ごとに追記）

## トラブルシューティング

### ログインに失敗する

- 環境変数が正しく設定されているか確認
- ログインID/パスワードが正しいか確認
- ブラウザで手動ログインが可能か確認

### 企業リンクが見つからない

- 企業リストが正しく表示されているか確認
- セレクタがサイトの構造と合っているか確認（必要に応じてスクリプトを修正）

### 詳細情報が取得できない

- `SAVE_HTML=1` でHTMLを保存して確認
- ブラウザの開発者ツールで要素を確認
- セレクタを調整する必要がある場合があります

## セレクタの調整

実際のサイト構造に合わせて、`scripts/cnavi_scrape.ts` 内のセレクタを調整する必要がある場合があります。

主要なセレクタ：

- ログインフォーム: `input[type="email"]`, `input[type="password"]`
- 企業リンク: `a:has-text("")`, `[class*="company"]`
- 基本情報テーブル: `table`, `[class*="table"]`
- 業績情報テーブル: `table` (売上/決算年を含む)


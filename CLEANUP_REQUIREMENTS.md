# データクリーンアップ要件

## 📋 8つの修正要件

### ✅ 要件1: 12.csvグループの重複統合
**対象**: タイプB（12.csv含む26ファイル）

**処理内容**:
- 法人番号 + 住所が同じ企業を統合
- 情報が最も充実しているドキュメントを正とする
- 不足フィールドを他のドキュメントから補完
- 統合後、重複ドキュメントを削除

**注意**: 企業名が同じでも法人番号・住所が違う場合は別企業として保持

---

### ✅ 要件2: 法人番号のバリデーション
**対象**: 全CSV

**処理内容**:
- 法人番号は13桁の数値のみ有効
- それ以外（文字列、桁数不足・超過）は削除してnull

**例**:
- ✅ `1234567890123` → 有効
- ❌ `ABC1234567890` → null
- ❌ `12345678901` → null（桁数不足）

---

### ✅ 要件3: 111.csv, 116.csvタイプの修正
**対象**: タイプD（111-115.csv）、タイプE（116-117.csv）

**処理内容**:
1. **削除フィールド**: ID, 取引種別, SBフラグ, NDA, AD, ステータス, 備考
2. **業種4ヘッダー追加**: 業種3と郵便番号の間に挿入
3. **郵便番号の判定修正**:
   - 3桁-4桁（例: 123-4567）→ 郵便番号
   - それ以外の文字列 → 業種4
4. **住所フィールドの修正**: 郵便番号が入っている場合は隣の列を使用

**例（丹羽興業株式会社）**:
- 誤: 住所 = `452-0834`
- 正: 住所 = `愛知県名古屋市西区木前町９８`

---

### ✅ 要件4: 127.csvタイプのヘッダー日本語化
**対象**: タイプG（127.csv, 128.csv）

**処理内容**:
1. 英語ヘッダーを日本語に変換
2. `companies_new`のフィールド名と統一
3. 内容を整理して再アップロード

**マッピング例**:
- `name` → `会社名` → DB: `name`
- `corporateNumber` → `法人番号` → DB: `corporateNumber`
- `banks` → `銀行` → DB: `banks`

---

### ✅ 要件5: 130.csv, 131.csvのヘッダー日本語化
**対象**: タイプH（130.csv, 131.csv）

**処理内容**:
1. 英語ヘッダーを日本語に変換（済み）
2. `companies_new`のフィールド名と統一（済み）
3. DBに入れる

**状態**: ✅ 既に修正済み

---

### ✅ 要件6: 132.csvタイプの大量フィールド削除
**対象**: タイプI（132.csv）

**削除フィールド**:
- ID
- 取引種別
- SBフラグ
- NDA
- AD
- ステータス
- 備考
- 売DM最終送信日時
- 買DM最終送信日時
- 売手紙最終送付日時
- 買手最終荷電日時
- 社長手紙最終送付日時
- SDS手紙最終送付日時
- SDS社長手紙最終送付日時

**法人番号の処理**:
- 13桁の数値のみ抽出
- それ以外は削除

---

### ✅ 要件7: 133.csvタイプの修正
**対象**: タイプJ（133-136.csv）

**処理内容**:
1. **削除フィールド**: 会社ID
2. **代表者情報の追加**: 他のCSVと同様に`representativeName`を追加

---

### ✅ 要件8: 134.csvの代表者名修正
**対象**: タイプJ（134.csv）

**処理内容**:
- 代表者名ヘッダーの内容をDBに正しく入れる

---

## 🔧 実装計画

### Phase 1: CSV修正スクリプト作成
1. ✅ タイプC修正（完了）
2. 🆕 タイプD, E修正（要件3）
3. 🆕 タイプG修正（要件4）
4. 🆕 タイプI修正（要件6）
5. 🆕 タイプJ修正（要件7, 8）

### Phase 2: バックフィルスクリプト改善
1. 🆕 法人番号バリデーション追加（要件2）
2. 🆕 重複統合ロジック強化（要件1）

### Phase 3: 実行
1. CSV修正実行
2. バックフィル実行（タイプ別）
3. 重複統合実行（タイプB）

---

## 📊 影響範囲

| 要件 | 対象タイプ | ファイル数 | 推定行数 | 優先度 |
|------|-----------|----------|---------|--------|
| 1 | タイプB | 26 | 94,060 | 🔴 高 |
| 2 | 全タイプ | 60 | 324,571 | 🔴 高 |
| 3 | タイプD, E | 7 | 35,173 | 🟡 中 |
| 4 | タイプG | 2 | 2,386 | 🟡 中 |
| 5 | タイプH | 2 | 14,506 | ✅ 済 |
| 6 | タイプI | 1 | 1,405 | 🟡 中 |
| 7,8 | タイプJ | 4 | 7,503 | 🟡 中 |

---

## ⚠️ 注意事項

1. **バックアップ**: 既存DBのバックアップを取得
2. **段階実行**: タイプ別に順次実行
3. **確認**: 各タイプ完了後、サンプル確認
4. **重複統合**: 最後にタイプB全体で実行


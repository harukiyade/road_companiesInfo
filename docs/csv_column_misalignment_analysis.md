# CSV「動的カラムズレ」解析レポート

## 1. 解析対象

35ファイル（csv/, fixed/, import_firstTime/ の指定ファイル）

---

## 2. ズレの法則まとめ

### 2.1 主パターン: データ行がヘッダーより1列（または2列）少ない

| パターン | 該当ファイル | 差分 | 推定原因 |
|----------|--------------|------|----------|
| **A: 常時 -1** | 大多数 | ヘッダーN列 vs データN-1列 | 行末の連続空列が1つ省略されて出力されている |
| **B: -2 混在** | fixed/107, fixed/109 | -2 または -1 | 同上。業種（細）が空の行で末尾空列が2つ省略される |
| **C: 全行 -1** | import_firstTime/105, 106 | 全データ行が-1 | ヘッダーの空列「創業」直後の(空)がデータ側で常に欠落 |
| **D: 複数方向** | import_firstTime/119 | +1〜+9 混在 | 説明・概要・仕入れ先等に**半角カンマ**が含まれ、クォートされていないため列が分割されて列数増 |

---

## 3. ズレ原因の特定

### 3.1 行末空列の省略（パターンA, B）

- **ヘッダー**: 実質32列の後に `Unnamed: 38`〜`Unnamed: 46` 等の空列が付与されている（pandas等で読んだ際の残骸）
- **データ行**: 元データ（Excel等）保存時に「行末の連続する空セル」が出力されず、末尾のカンマが1つ（または2つ）少ない
- **結果**: データ行の列数がヘッダーより1（または2）少なくなる

### 3.2 業種列の構造差（122系）

**csv/122.csv** ヘッダー:  
`業種1, 業種2, 業種3, 郵便番号, 住所, 業種（細）, 設立, ...`

- 業種（細）が**郵便番号・住所の後**に来る構造
- 一方、一部データ行では業種4・業種5に相当する値（例: その他の事業サービス業, 一般貨物自動車運送業）が**郵便番号の前に**入っており、業種列の可変長が存在
- ただし今回の解析では列数は「データが1列少ない」パターン。業種の多さは列数増の要因だが、末尾空列省略の方が支配的

### 3.3 半角カンマによる列分割（import_firstTime/119.csv）

- 説明・概要・仕入れ先・取引先・取引先銀行・取締役・株主 等に `，`（全角）ではなく `,`（半角）が含まれると、CSVパーサーが区切りとして解釈
- クォートされていなければ列が分割され、列数が **+1〜+9** 増加
- 例: `（取）〇〇，××（監）△△` の `，` が全角なら1列、半角なら複数列に分かれる

### 3.4 ヘッダー側の空列（import_firstTime/105.csv）

- ヘッダー: `創業, (空), 設立, ...` の形で空列が存在
- データ側ではこの空列が出力されず、常に1列少ない

---

## 4. ファイル別ズレ詳細

| ファイル | ヘッダー列数 | 主な差分 | ズレあり行数 | メモ |
|----------|--------------|----------|--------------|------|
| csv/107-117, 122 | 37〜41 | -1 | 各数千〜2万 | 行末空列1つ省略 |
| fixed/107, 109 | 41 | -2, -1 | 約2万/約2万 | 行末空列2つ省略の行あり |
| fixed/110-117, 122 | 36〜40 | -1 | 各2千〜5千 | 行末空列1つ省略 |
| import_firstTime/105 | 19 | -1 | 299(全行) | 創業直後の空列がデータにない |
| import_firstTime/106 | 20 | -1 | 5921(全行) | 同様の空列欠落 |
| import_firstTime/107, 110-118, 122 | 37〜41 | -1 | 各数千 | 行末空列1つ省略 |
| import_firstTime/119 | 38 | +1〜+9 | 約6千 | 半角カンマによる列分割 |

---

## 5. マッピング特定のヒント

### 5.1 判定基準に基づく列の同定

- **法人番号**: 13桁数値。`9180000000000` で始まるものはダミー→空値扱い推奨
- **郵便番号**: `\d{3}-?\d{4}` 形式（例: 452-0834, 4520834）
- **住所**: 都道府県名から始まる文字列（愛知県、静岡県 等）
- **URL**: `http` または `https` で始まる文字列
- **フラグ系**: NDA, AD, SBフラグ, 未設定, 未送信 等

### 5.2 ズレ行の修復方針

1. **-1列の行**: 末尾に空列を1つ追加してヘッダー列数に合わせる
2. **-2列の行**: 末尾に空列を2つ追加
3. **+N列の行（119系）**: 説明・概要等の長文フィールドに半角カンマが含まれると分割されている。該当列を特定し、隣接列を連結して元の1列に戻す必要あり（または、元データで該当フィールドをダブルクォートで囲むよう修正）

### 5.3 業種列の扱い

- 業種1〜3（または業種4）の後に「業種（細）」が来る構成と、「業種（細）」が郵便番号・住所の後に来る構成が混在
- データ行によっては業種4・業種5に相当する値が存在。業種列は可変長として扱い、郵便番号パターン（`\d{3}-?\d{4}`）が出現する直前までを業種系として解釈する方法が有効

---

## 6. サンプルデータ（貼付用）

### csv/107.csv（1行目＋問題のデータ行）

```
会社名,都道府県,代表者名,法人番号,URL,業種1,業種2,業種3,業種（細）,郵便番号,住所,設立,電話番号(窓口),代表者郵便番号,代表者住所,代表者誕生日,資本金,上場,直近決算年月,直近売上,直近利益,説明,概要,仕入れ先,取引先,取引先銀行,取締役,株主,社員数,オフィス数,工場数,店舗数,Unnamed: 38,Unnamed: 39,Unnamed: 40,Unnamed: 41,Unnamed: 42,Unnamed: 43,Unnamed: 44,Unnamed: 45,Unnamed: 46
丹羽興業株式会社,愛知県,前田義浩,9180000000000,http://www.1049.cc/web/niwa-net/,労働者派遣業,集配利用運送業,一般貨物自動車運送業,その他の事業サービス業,452-0834,愛知県名古屋市西区木前町９８,20852,052-504-1511,451-0012,愛知県名古屋市西区稲生町杁先２２００－１０,,100000,非上場,45139,2327013,115765,貨物の運送などを行っている会社,三菱重工業（株）の協力会社で物流業務を担当、２０２２年１２月期は売上利益ともに回復を見せた。,東海ニチユ，三菱ふそうトラック・バス，三菱重工冷熱，三菱ロジスネクスト，西日本宇佐美，アクティブシックスオー,村田機械（２７％），三菱重工業（２３％），サカエ理研工業（１０％），三菱重工サーマルシステムズ,三菱ＵＦＪ（小田井）岡崎信金（小田井）愛知（小田井）碧海信金（名古屋）,（取）前田啓子，服部汰馨子（監）奥田健人,ラック（４０．９％），前田義郎（３６．１％），前田啓子（１７．９％）,180,8,0,0,,,,,,,,
株式会社やぶやグループ,愛知県,横瀬武夫,9180000000000,https://www.yabuya.com/,飲食店,酒場，ビヤホール,食堂，レストラン,,450-0002,愛知県名古屋市中村区名駅４－２０－８西栁ＳＴビル,35034,052-583-9828,480-0202,愛知県西春日井郡豊山町豊場高畑６－２７,1965-12-27 00:00:00,3000,非上場,45139,658989,48135,居酒屋「やぶ屋」を運営する会社,...
藤吉工業株式会社,愛知県,加藤靖始,8180000000000,https://www.fujiyoshi.co.jp/,建築工事業,給排水・衛生設備工事業,一般機械修理業,検査業,453-0801,愛知県名古屋市中村区太閤４－２－８,22372,052-451-8261,,,,200000,非上場,44805,6401064,449392,...
```

### csv/122.csv（業種と郵便番号の順序が異なる例）

```
会社名,都道府県,代表者名,URL,業種1,業種2,業種3,郵便番号,住所,業種（細）,設立,電話番号(窓口),...
株式会社TF‐METAL磐田,静岡県,菅沼豊,http://www.iwata-fujikiko.jp,自動車製造業（二輪自動車を含む）,自動車部分品・附属品製造業,,438-0212,静岡県磐田市海老島１４６１番地,1996年11月1日,0538-66-7121,...
共立運輸株式会社,静岡県,伊藤忠永,http://www.fuji-milk.co.jp/group/03.html,集配利用運送業,一般貨物自動車運送業,その他の運輸附帯サービス業,その他の事業サービス業,一般貨物自動車運送業,,418-0015,静岡県富士宮市舞々木町６６３,...
```

※3行目: 業種4・業種5相当の値が郵便番号位置より前にあり、列構造が他行と異なる

### import_firstTime/105.csv（空列欠落）

```
会社名,電話番号,郵便番号,住所,URL,代表者,郵便番号,住所,創業,,設立,株式保有率,役員,概要,業種（大）,業種（細）,業種（中）,業種（小）,業種（細）
株式会社海幸水産,048-862-1254,338-0837,埼玉県さいたま市桜区田島１－２－１,https://kaikosuisan.co.jp/,深井勇哉,338-0837,埼玉県さいたま市桜区田島１－１－２３,1992/4/23,学校給食向け食材の加工・販売（１００％）,1961年9月1日,...
```

※ヘッダー「創業」の次に空列があるが、データ行では「創業」の次が直接「設立」の値になっている（空列が欠落）

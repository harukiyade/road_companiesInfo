/* 
  ãƒ†ã‚¹ãƒˆç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
  
  ä½¿ã„æ–¹:
    GOOGLE_APPLICATION_CREDENTIALS=./albert-ma-firebase-adminsdk-iat1k-a64039899f.json \
    npx ts-node scripts/delete_test_companies_by_group.ts [ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å]
*/

import * as fs from "fs";
import * as path from "path";
import admin from "firebase-admin";
import type { Firestore, CollectionReference, WriteBatch } from "firebase-admin/firestore";

const COLLECTION_NAME = "companies_new";
const BATCH_LIMIT = 500;

// ==============================
// Firebase åˆæœŸåŒ–
// ==============================
if (admin.apps.length === 0) {
  let serviceAccountPath = process.env.GOOGLE_APPLICATION_CREDENTIALS;

  if (!serviceAccountPath) {
    const projectRoot = process.cwd();
    const defaultPaths = [
      "./albert-ma-firebase-adminsdk-iat1k-a64039899f.json",
      "./serviceAccountKey.json",
      "./service-account-key.json",
      "./firebase-service-account.json",
      path.join(projectRoot, "albert-ma-firebase-adminsdk-iat1k-a64039899f.json"),
      path.join(projectRoot, "serviceAccountKey.json"),
      path.join(projectRoot, "service-account-key.json"),
      path.join(projectRoot, "firebase-service-account.json"),
      path.join(projectRoot, "config", "serviceAccountKey.json"),
      path.join(projectRoot, ".config", "serviceAccountKey.json"),
    ];

    for (const pth of defaultPaths) {
      const resolved = path.resolve(pth);
      if (fs.existsSync(resolved)) {
        serviceAccountPath = resolved;
        console.log(`â„¹ï¸  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨: ${resolved}`);
        break;
      }
    }
  }

  if (!serviceAccountPath) {
    console.error("âŒ ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
    process.exit(1);
  }
  if (!fs.existsSync(serviceAccountPath)) {
    console.error(`âŒ ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${serviceAccountPath}`);
    process.exit(1);
  }

  try {
    const serviceAccount = JSON.parse(fs.readFileSync(serviceAccountPath, "utf8"));
    const projectId =
      serviceAccount.project_id ||
      process.env.GCLOUD_PROJECT ||
      process.env.GCP_PROJECT;

    if (!projectId) {
      console.error("âŒ ã‚¨ãƒ©ãƒ¼: Project ID ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ");
      process.exit(1);
    }

    admin.initializeApp({
      credential: admin.credential.cert(serviceAccount),
      projectId,
    });

    console.log(`âœ… Firebase åˆæœŸåŒ–å®Œäº† (Project ID: ${projectId})`);
  } catch (err: any) {
    console.error("âŒ ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
    console.error(`   è©³ç´°: ${err.message}`);
    process.exit(1);
  }
}

const db: Firestore = admin.firestore();
const companiesCol: CollectionReference = db.collection(COLLECTION_NAME);

// ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’æŠ½å‡º
function parseDocIdsFromLog(logFileName: string): string[] {
  const content = fs.readFileSync(logFileName, "utf8");
  const lines = content.split("\n").filter(l => l.trim());
  const docIds: string[] = [];

  for (const line of lines) {
    // å½¢å¼: "group1 - 111.csv - è¡Œ1: 17654755738284039 (ä¸¹ç¾½èˆˆæ¥­æ ªå¼ä¼šç¤¾)"
    const match = line.match(/è¡Œ\d+:\s+([^\s]+)\s+\(/);
    if (match) {
      docIds.push(match[1]);
    }
  }

  return docIds;
}

// ãƒ¡ã‚¤ãƒ³å‡¦ç†
async function main() {
  const logFileName = process.argv[2] || "created_test_companies_1765475578651.txt";
  
  if (!fs.existsSync(logFileName)) {
    console.error(`âŒ ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${logFileName}`);
    process.exit(1);
  }

  console.log(`ğŸ“„ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: ${logFileName}\n`);

  // ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’æŠ½å‡º
  const docIds = parseDocIdsFromLog(logFileName);
  console.log(`ğŸ“Š å‰Šé™¤å¯¾è±¡: ${docIds.length}ä»¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\n`);

  if (docIds.length === 0) {
    console.log("âš ï¸  å‰Šé™¤å¯¾è±¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
    return;
  }

  // å‰Šé™¤å®Ÿè¡Œ
  let batch: WriteBatch = db.batch();
  let batchCount = 0;
  let totalDeleted = 0;

  console.log("ğŸ—‘ï¸  å‰Šé™¤ã‚’é–‹å§‹ã—ã¾ã™...\n");

  for (const docId of docIds) {
    try {
      const docRef = companiesCol.doc(docId);
      batch.delete(docRef);
      batchCount++;
      totalDeleted++;

      if (batchCount >= BATCH_LIMIT) {
        await batch.commit();
        console.log(`  âœ… ãƒãƒƒãƒå‰Šé™¤: ${BATCH_LIMIT}ä»¶`);
        batch = db.batch();
        batchCount = 0;
      }
    } catch (err: any) {
      console.error(`  âš ï¸  å‰Šé™¤ã‚¨ãƒ©ãƒ¼ (${docId}): ${err.message}`);
    }
  }

  // æ®‹ã‚Šã®ãƒãƒƒãƒã‚’ã‚³ãƒŸãƒƒãƒˆ
  if (batchCount > 0) {
    await batch.commit();
    console.log(`  âœ… æœ€çµ‚ãƒãƒƒãƒå‰Šé™¤: ${batchCount}ä»¶`);
  }

  console.log("\n" + "=".repeat(80));
  console.log(`âœ… å‰Šé™¤å®Œäº†: ${totalDeleted}ä»¶ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
  console.log("=".repeat(80));
}

main().catch((err) => {
  console.error("âŒ è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼:", err);
  process.exit(1);
});


# ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ‰‹é †ï¼ˆ8ã¤ã®è¦ä»¶å¯¾å¿œï¼‰

## ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹

| ã‚¹ãƒ†ãƒƒãƒ— | å†…å®¹ | çŠ¶æ…‹ |
|---------|------|------|
| ã‚¹ãƒ†ãƒƒãƒ—1 | CSVä¿®æ­£ | âœ… å®Œäº† |
| ã‚¹ãƒ†ãƒƒãƒ—2 | ãƒ•ã‚¡ã‚¤ãƒ«ç½®ãæ›ãˆ | âœ… å®Œäº† |
| ã‚¹ãƒ†ãƒƒãƒ—3 | ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ« | âœ… å®Œäº† |
| ã‚¹ãƒ†ãƒƒãƒ—4 | é‡è¤‡çµ±åˆ | â³ æœªå®Œäº† |

**å®Ÿè¡Œæ¸ˆã¿:**
- ã‚¿ã‚¤ãƒ—D, E, G, I, J ã®CSVä¿®æ­£ãƒ»ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«å®Œäº†
- æ³•äººç•ªå·ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨æ¸ˆã¿

**æ®‹ã‚Šã®ã‚¿ã‚¹ã‚¯:**
- ã‚¿ã‚¤ãƒ—Bï¼ˆ12.csvã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã®é‡è¤‡çµ±åˆ

---

## ğŸš€ ã‚¹ãƒ†ãƒƒãƒ—4: é‡è¤‡çµ±åˆã‚’å®Ÿè¡Œ

### ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š

```bash
cd /Users/harumacmini/Downloads/road_companiesInfo

export GOOGLE_APPLICATION_CREDENTIALS=./albert-ma-firebase-adminsdk-iat1k-a64039899f.json
```

### å®Ÿè¡Œæ–¹æ³•ï¼ˆ2ã¤ã®é¸æŠè‚¢ï¼‰

#### é¸æŠè‚¢A: ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè¡Œ

```bash
bash scripts/run_step4_dedupe.sh
```

#### é¸æŠè‚¢B: ç›´æ¥å®Ÿè¡Œ

```bash
NODE_OPTIONS="--max-old-space-size=8192" \
npx ts-node scripts/dedupe_type_b_companies_batch.ts
```

---

## â±ï¸ å‡¦ç†æ™‚é–“

**æ¨å®š: 30åˆ†ã€œ1æ™‚é–“**

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
ãƒ•ã‚§ãƒ¼ã‚º1: æ³•äººç•ªå·åé›†ï¼ˆ10-20åˆ†ï¼‰
  â†’ 67ä¸‡ä»¶ã‚’ã‚¹ã‚­ãƒ£ãƒ³
  â†’ ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ³•äººç•ªå·ã‚’æŠ½å‡º
  â†’ é€²æ—è¡¨ç¤º: 10,000ä»¶ã”ã¨

ãƒ•ã‚§ãƒ¼ã‚º2: é‡è¤‡çµ±åˆï¼ˆ20-40åˆ†ï¼‰
  â†’ å„æ³•äººç•ªå·ã§é‡è¤‡æ¤œç´¢
  â†’ æƒ…å ±ã‚’çµ±åˆ
  â†’ é‡è¤‡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‰Šé™¤
  â†’ é€²æ—è¡¨ç¤º: 100ä»¶ã”ã¨
```

---

## ğŸ“Š å®Ÿè¡Œä¸­ã®è¡¨ç¤ºä¾‹

```
ğŸ” é‡è¤‡å€™è£œã®æ³•äººç•ªå·ã‚’åé›†ä¸­...

  é€²è¡Œä¸­... 10000ä»¶ã‚¹ã‚­ãƒ£ãƒ³ã€5234å€‹ã®æ³•äººç•ªå·ã‚’ç™ºè¦‹
  é€²è¡Œä¸­... 20000ä»¶ã‚¹ã‚­ãƒ£ãƒ³ã€10145å€‹ã®æ³•äººç•ªå·ã‚’ç™ºè¦‹
  ...

âœ… ç·ã‚¹ã‚­ãƒ£ãƒ³æ•°: 670000ä»¶
âœ… ãƒ¦ãƒ‹ãƒ¼ã‚¯æ³•äººç•ªå·: 95000å€‹

ğŸ”„ é‡è¤‡çµ±åˆã‚’é–‹å§‹ã—ã¾ã™...

ğŸ“¦ æ³•äººç•ªå·: 1234567890123
   ä¼æ¥­å: æ ªå¼ä¼šç¤¾ã€‡ã€‡
   é‡è¤‡æ•°: 3ä»¶
   æ­£: docId=1234567890123 (45ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰)
   å‰Šé™¤: docId=1763986225913189059 (30ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰)
   å‰Šé™¤: docId=1763986298960194062 (25ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰)
   âœ¨ çµ±åˆå¾Œ: 52ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (+7)
   âœ… çµ±åˆå®Œäº†

...

ğŸ“Š é€²æ—: 100/95000ä»¶å‡¦ç†å®Œäº†ï¼ˆé‡è¤‡15ä»¶ã€å‰Šé™¤30ä»¶ï¼‰

...

============================================================
ğŸ‰ çµ±åˆå®Œäº†ï¼
   å‡¦ç†æ³•äººç•ªå·æ•°: 95000
   é‡è¤‡ç™ºè¦‹æ•°: 5000
   å‰Šé™¤ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°: 12000
============================================================
```

---

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆ

```bash
# ãƒ’ãƒ¼ãƒ—ã‚µã‚¤ã‚ºã‚’ã•ã‚‰ã«å¢—ã‚„ã™
NODE_OPTIONS="--max-old-space-size=16384" \
npx ts-node scripts/dedupe_type_b_companies_batch.ts
```

### é€”ä¸­ã§åœæ­¢ã—ãŸå ´åˆ

**å®‰å…¨ã§ã™ï¼** å‡¦ç†æ¸ˆã¿ã®çµ±åˆã¯å®Œäº†ã—ã¦ã„ã‚‹ãŸã‚ã€å†å®Ÿè¡Œã—ã¦ã‚‚OKã€‚
- æ—¢ã«çµ±åˆæ¸ˆã¿ã®æ³•äººç•ªå·ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™
- æ®‹ã‚Šã®æ³•äººç•ªå·ã‹ã‚‰å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™

```bash
# å˜ç´”ã«å†å®Ÿè¡Œ
bash scripts/run_step4_dedupe.sh
```

### é€²æ—ãŒæ­¢ã¾ã£ã¦ã„ã‚‹ã‚ˆã†ã«è¦‹ãˆã‚‹å ´åˆ

**æ­£å¸¸ã§ã™ï¼** 
- é‡è¤‡ãŒå°‘ãªã„æ³•äººç•ªå·ã¯ç¬æ™‚ã«å‡¦ç†
- é‡è¤‡ãŒå¤šã„æ³•äººç•ªå·ï¼ˆ100ä»¶ä»¥ä¸Šï¼‰ã¯æ™‚é–“ãŒã‹ã‹ã‚‹
- 100ä»¶ã”ã¨ã«é€²æ—ãŒè¡¨ç¤ºã•ã‚Œã¾ã™

---

## ğŸ” DRY RUNï¼ˆäº‹å‰ç¢ºèªï¼‰

å®Ÿéš›ã«å‰Šé™¤ã™ã‚‹å‰ã«ã€é‡è¤‡çŠ¶æ³ã‚’ç¢ºèªã—ãŸã„å ´åˆï¼š

```bash
export GOOGLE_APPLICATION_CREDENTIALS=./albert-ma-firebase-adminsdk-iat1k-a64039899f.json

NODE_OPTIONS="--max-old-space-size=8192" \
npx ts-node scripts/dedupe_type_b_companies_batch.ts --dry-run
```

**DRY RUN ã§ã¯:**
- âœ… é‡è¤‡ã‚’æ¤œå‡ºãƒ»è¡¨ç¤º
- âŒ å®Ÿéš›ã®æ›´æ–°ãƒ»å‰Šé™¤ã¯è¡Œã‚ãªã„
- ğŸ“Š çµ±è¨ˆæƒ…å ±ã®ã¿å‡ºåŠ›

---

## ğŸ“Œ å®Ÿè¡Œå¾Œã®ç¢ºèª

### 1. ä¸¹ç¾½èˆˆæ¥­æ ªå¼ä¼šç¤¾ã®ç¢ºèª

```bash
npx ts-node scripts/quick_query.ts name "ä¸¹ç¾½èˆˆæ¥­æ ªå¼ä¼šç¤¾"
```

**æœŸå¾…çµæœ:** 11ä»¶ â†’ 1ä»¶ã«çµ±åˆ

### 2. ç·ä»¶æ•°ã®ç¢ºèª

```bash
npx ts-node scripts/quick_query.ts count
```

**æœŸå¾…çµæœ:** ç´„67ä¸‡ä»¶ â†’ ç´„66ä¸‡ä»¶ï¼ˆç´„1ä¸‡ä»¶å‰Šæ¸›ï¼‰

### 3. ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒ«ç¢ºèª

```bash
npx ts-node scripts/quick_query.ts random 10
```

**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:**
- ä¼æ¥­åãŒæ­£ã—ãå…¥ã£ã¦ã„ã‚‹ã‹
- æ³•äººç•ªå·ãŒ13æ¡ã®æ•°å€¤ã®ã¿ã‹
- ä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå……å®Ÿã—ã¦ã„ã‚‹ã‹

---

## ğŸ¯ å…¨ä½“ã®æµã‚Œï¼ˆãŠã•ã‚‰ã„ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—1-3ï¼ˆå®Œäº†æ¸ˆã¿ï¼‰

```bash
# ã“ã‚Œã‚‰ã¯æ—¢ã«å®Œäº†ã—ã¦ã„ã¾ã™
âœ… python3 scripts/fix_all_csv_requirements.py
âœ… CSVç½®ãæ›ãˆ
âœ… npx ts-node scripts/backfill_companies_from_csv.ts (ã‚¿ã‚¤ãƒ—D, E, G, I, J)
```

### ã‚¹ãƒ†ãƒƒãƒ—4ï¼ˆã“ã‚Œã‹ã‚‰å®Ÿè¡Œï¼‰

```bash
export GOOGLE_APPLICATION_CREDENTIALS=./albert-ma-firebase-adminsdk-iat1k-a64039899f.json

bash scripts/run_step4_dedupe.sh
```

### ã‚¹ãƒ†ãƒƒãƒ—5ï¼ˆå®Ÿè¡Œå¾Œã®ç¢ºèªï¼‰

```bash
# ã‚µãƒ³ãƒ—ãƒ«ç¢ºèª
npx ts-node scripts/verify_csv_import_by_type.ts

# DBãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã§æ‰‹å‹•ç¢ºèª
npx ts-node scripts/db_browser.ts
```

---

## âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …

1. **é€”ä¸­ã§åœæ­¢ã—ãªã„**: å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…ã¤
2. **ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‰ã˜ãªã„**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œã§ã¯ãªã„
3. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶š**: Firestoreã¸ã®æ¥ç¶šãŒå¿…è¦
4. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: å¿µã®ãŸã‚äº‹å‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¨å¥¨

---

## ğŸ’¡ ãƒ’ãƒ³ãƒˆ

### ä¸¦è¡Œã—ã¦ç¢ºèªã—ãŸã„å ´åˆ

**åˆ¥ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§:**

```bash
# ç·ä»¶æ•°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç¢ºèª
watch -n 60 'GOOGLE_APPLICATION_CREDENTIALS=./albert-ma-firebase-adminsdk-iat1k-a64039899f.json npx ts-node scripts/quick_query.ts count'
```

### ãƒ­ã‚°ã‚’æ®‹ã—ãŸã„å ´åˆ

```bash
bash scripts/run_step4_dedupe.sh 2>&1 | tee dedupe_log.txt
```

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ:
- `UPDATE_PROCEDURE.md`: ã“ã®æ‰‹é †æ›¸
- `CLEANUP_REQUIREMENTS.md`: è¦ä»¶è©³ç´°
- `scripts/dedupe_type_b_companies_batch.ts`: ãƒãƒƒãƒå‡¦ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

